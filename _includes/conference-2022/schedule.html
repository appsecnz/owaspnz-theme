<section>
{% assign dev_file = site.static_files | where: "name", "devsite.txt" %}
{% if dev_file.size > 0 %}
{% assign site_base_url = '/' %}
{% else %}
{% assign site_base_url = 'https://appsec.org.nz/' %}
{% endif %}
  <script type="text/javascript">
    var track_info = [];
    var day_info = [];
    var block_info = [];
    var talk_info = [];
    var numTracks;
        
    
    function build_block_html( currBlock ) {
       var htmlText = '';
       if( currBlock ) {
    	   htmlText += '<td style="vertical-align: middle; text-align: right;">' + currBlock["start"];
    	   if(currBlock["end"]) {
    		   htmlText+='&nbsp;-&nbsp;' + currBlock["end"];
    	   }
    	   htmlText += '</td>\n';
       }
       return htmlText;
    }
    
    function build_plenary_td( currTalk, numTracks ) {
    	var htmlText = '';
    	
    	htmlText += '<td colspan="' + (numTracks + 1) + '" style="background-color: #D98B66; text-align: center; margin: 15px 5px;">';
    	if( currTalk["title"] ) {
    		htmlText += '<strong>' + currTalk["title"] + '</strong>';
    		if( currTalk["name"]) {
    			htmlText += '\n<br />\n';
    		}
    	}
    	if( currTalk["name"] ) {
    		htmlText += '<em>' + currTalk["name"];
    		if( currTalk["org"] ) {
    			htmlText += ' - ' + currTalk["org"];
    		}
    		htmlText += '</em>';
    	}
    	htmlText += '\n</td>\n';
    	
    	return htmlText;
    }
    
    function build_talk_td( currTalk, isOddRow ) {
    	if( isOddRow ) {
    		htmlText = '<td style="background-color: #EEE; text-align: center; margin: 15px 5px;">\n';
    	}
    	else {
    		htmlText = '<td style="background-color: #B9C2DC; text-align: center; margin: 15px 5px;">\n';
    	}
    	htmlText += '<strong><a href="/conference/speakers.html#' + currTalk["anchor"] + '" target="speakers">';
    	htmlText += currTalk["title"] + '</a></strong>\n<br />\n<em>' + currTalk["name"];
    	if( currTalk["org"] ) {
    		htmlText += ' - ' + currTalk["org"];
    	}
    	htmlText += '</em>\n';
    	htmlText += '</td>\n';
    	return htmlText;
    }
    
    function build_breakout_td( oddRow ) {
    	var htmlText = '';
    	if( isOddRow ) {
    		htmlText = '<td style="background-color: #EEE; text-align: center; margin: 15px 5px;">&nbsp;</td>\n';
    	}
    	else {
    		htmlText = '<td style="background-color: #B9C2DC; text-align: center; margin: 15px 5px;">&nbsp;</td>\n';
    	}
    	return htmlText;
    }
    
    function build_header_row( trackData ) {
    	var htmlText = '';
    	
    	htmlText += '<tr>\n<td style="vertical-align: middle; text-align: right;">&nbsp;</td>\n';
    	for( track in trackData ) {
    		htmlText += '<td style="background-color: #B9C2DC; text-align: center; font-weight: bold; margin: 15px 5px; width: ' + track["width"] + '%;">\n';
    		htmlText += track["name"] + '\n<br />\n' + track["location"];
    		if( track["overflow"] ) {
    			htmlText += ' (Overflow: ' + track["overflow"] + ')';
    		}
    		htmlText += '</td>\n';
    	}
    	htmlText += '</tr>\n';
    	return htmlText;
    }

    $(function() {  
      var track_list = YAML.load('{{site_base_url}}assets/sitedata/tracks-2022.yml');
      track_list.sort((a, b) => (a.id > b.id) ? 1 : -1 );
      
      $.each(track_list, function(trackIndex) {
    	trackIndex = track_info.push(this) - 1;
      });
      numTracks = track_info.length;
      
      var day_list = YAML.load('{{site_base_url}}assets/sitedata/schedule-2022.yml');
      day_list.sort((a, b) => (a.day > b.day) ? 1 : -1 );

      $.each(day_list, function(dayIndex) {
  		dayIndex = day_info.push(this) - 1;
  		var blockData = [];
  		$.each( this.time_blocks, function(blockIndex) {
  			blockIndex = blockData.push(this) - 1;
  		});
  		block_info.push(blockData);
      });
        
      var talk_list = YAML.load('{{site_base_url}}assets/sitedata/talks-2022.yml');
      talk_list.sort((a, b) => (a.day > b.day) ? 1 : ((a.block > b.block) ? 1 : ((a.track > b.track) ? 1 : -1) ) );
      
      var talkDay, talkBlock, talkTrack, lastDay = 0, lastBlock = 0;
      var talks_for_day = [];
	  var talks_for_block = [];
      $.each(talk_list, function() {
    	  talkDay = this.day;
    	  talkBlock = this.block;
    	  talkTrack = this.track;
    	  if(talkDay != lastDay) {
    		  talks_for_day.push(talks_for_block);
    		  talks_for_block = [];
    		  talk_info.push(talks_for_day);
    		  talks_for_day = [];
    	  }
    	  else {
    		  if(talkBlock != lastBlock) {
    			  talks_for_day.push(talks_for_block);
    			  talks_for_block = [];
    		  }
    	  }
    	  talks_for_block.push(this);
    	  lastDay = talkDay;
    	  lastBlock = talkBlock;
      });
      if( talks_for_block.length > 0 ) {
    	  talks_for_day.push(talks_for_block);
      }
      if( talks_for_day.length > 0 ) {
    	  talk_info.push(talks_for_day);
      }

      
        var current_talk;
        var dayIndex = 0;
        var blockIndex = 0;
        var trackIndex = 0;
        var htmlString = "";
        var dayBlocks;
        var blockTalks;
        var oddRow = true;
        var lastPlenary = false;
        
       	for( day in day_info ) {
       		dayIndex = day["day"];
       		dayBlocks = block_info[dayIndex];
       		htmlString += '<h2>' + day["dayofweek"] + ', ' + day["date"] + ' ' + day["month"] + ' ' + day["year"] + '</h2>\n\n';
       		htmlString += '<table width="100%">\n';
       		htmlString += build_header_row( track_info );
       		for( block in dayBlocks ) {
       			blockIndex = block["block"];
       			
       			htmlString += '<tr>\n';
       			htmlString += build_block_html(block);
       			
       			blockTalks = talk_info[dayIndex][blockIndex];
       			for( current_talk in blockTalks ) {
       				if(current_talk.plenary) {
       					htmlString += build_plenary_td( current_talk );
       					lastPlenary = true;
       				}
       				else {
       					htmlString += build_talk_td( current_talk, oddRow );
       				}
       			}
       			htmlString += build_breakout_td( oddRow );
       			htmlString += '</tr>\n';
       			if( !lastPlenary ) {
       				oddRow = !oddRow;
       			}
       			lastPlenary = false;
       		}
       	
       	    htmlString += '</table>\n\n';
       	}
                
       	$("#schedule_div").html(htmlString);
          
    });
  </script>

  <div id="schedule_div">
  </div>
</section>
